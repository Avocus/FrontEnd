trigger:
  branches:
    include:
      - main  # Aciona o pipeline quando a branch 'main' for atualizada

pool:
  name: 'Azure Pipelines'

steps:
  # 1. Checkout completo da branch main (sem clone superficial)
  - checkout: self
    fetchDepth: 0

  # 2. Configurar o Git com suas credenciais
  - script: |
      echo Configurando Git...
      git config --global user.email "avocuss@gmail.com"
      git config --global user.name "Avocuss"
    displayName: 'Configurar Git'

  # 3. Exibir o commit atual (do DevOps)
  - script: |
      echo "Commit atual (DevOps):"
      git rev-parse HEAD
    displayName: 'Verificar commit atual'

  # 4. Garantir que a branch main local esteja atualizada
  - script: |
      echo "Atualizando a referência da branch main para o commit atual..."
      git checkout -B main
      echo Nova referência da branch main:
      git rev-parse main
    displayName: 'Atualizar branch main local'

  # 5. Adicionar o repositório do GitHub como remote
  - script: |
      echo "Adicionando repositório GitHub como remote..."
      #rem Remove remote 'github' se já existir (ignora erro, se não existir)
      git remote remove github 2>NUL || echo "Remote 'github' não existia"
      git remote add github https://$(GITHUB_TOKEN)@github.com/Avocus/FrontEnd.git
      git remote -v
    displayName: 'Adicionar GitHub como remote'

  # 5.1. Reescrever o commit para definir o autor como Avocuss
  - script: |
      echo "Reescrevendo o commit para definir o autor como Avocuss..."
      git config user.email "avocuss@gmail.com"
      git config user.name "Avocuss"
      git commit --amend --no-edit --reset-author
    displayName: 'Atualizar autor do commit'

  # 6. Push da branch main para o GitHub
  - script: |
      echo "Enviando código para a branch main do GitHub..."
      git push --force github main
    displayName: 'Push para o GitHub'

  # 7. Verificar o commit atual no GitHub
  - script: |
      echo "Verificando commit remoto no GitHub..."
      git fetch github main
      git rev-parse github/main
    displayName: 'Verificar commit do GitHub'
